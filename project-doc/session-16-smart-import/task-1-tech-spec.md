# Task 1: CSV Format Detector + Supplier Row Converter — Tech-spec

## File to Create

`frontend-sveltekit/src/lib/server/import/csv-format-detector.ts`

## Exports

### Type: `CsvFormat`
```typescript
type CsvFormat = 'native' | 'supplier' | 'unknown';
```

### Function: `detectCsvFormat(headers: string[]): CsvFormat`
- If any of `['slug', 'brand_slug', 'specs_json']` present → `'native'`
- If any of `['Имя', 'Бренд', 'Артикул (Ref)', 'Пол']` present → `'supplier'`
- Else → `'unknown'`

### Function: `convertSupplierRows(rows: Record<string, string>[]): ConversionResult`

Returns:
```typescript
interface ConversionResult {
  rows: Record<string, string>[];
  brandNames: Map<string, string>;  // brand_slug → original name
  categoryNames: Map<string, string>;  // category_slug → Russian name
}
```

**Column mapping:**

| Source Column | Target Column | Logic |
|---|---|---|
| `Имя` | `name` | trim |
| `Бренд` | `brand_slug` | `makeBrandSlug(value)` |
| `Артикул (Ref)` | `sku` | trim |
| `Цена` | `price` | trim, as-is (already in RUB) |
| `Пол` | `category_slug` | `GENDER_MAP[value]` |
| `Коллекция` | `description` | `"Коллекция: {value}"` (if not empty) |
| `Фото` | `main_image` | If numeric → `"{id}.jpg"`, else as-is |
| 8 spec columns | `specs_json` | `buildSpecsJson(row)` |

**Not mapped (defaults):**
- `slug` → empty (auto-generated by product-importer from `name`)
- `price_note` → empty
- `availability_status` → empty (defaults to 'in-stock')
- `is_active` → '1'
- `is_featured` → '0'
- `is_new` → '0'
- `is_limited` → '0'
- `position` → '0'
- `gallery_images` → empty

### Helper: `makeBrandSlug(brand: string): string`
```
"Tissot " → "tissot"
"ATOWAK" → "atowak"
```
Logic: trim → toLowerCase → replace spaces/special chars with `-` → remove leading/trailing `-`

### Helper: `buildSpecsJson(row): string`
Builds JSON with 3 groups:

**Group "Корпус":**
- `Корпус` → label `"Материал"`
- `Размер (мм)` → label `"Диаметр"`, append `" мм"` if missing
- `Толщ, (мм)` or `Толщ. (мм)` → label `"Толщина"`, append `" мм"` if missing
- `Водозащита` → label `"Водозащита"`

**Group "Механизм":**
- `Мех-м` → label `"Тип"`
- `Калибр` → label `"Калибр"`
- `Запас хода` → label `"Запас хода"` (skip if `-`)

**Group "Внешний вид":**
- `Циферблат` → label `"Циферблат"`
- `Ремешок/Браслет` → label `"Ремешок/Браслет"`

**Rules:**
- Skip entries where value is `-`, empty, or only whitespace
- Keep comma-decimals as-is (`10,5`)
- Append `" мм"` to Размер/Толщина only if value doesn't already contain `"мм"`

### Constant: `GENDER_MAP`
```typescript
const GENDER_MAP: Record<string, string> = {
  'Мужские': 'mens',
  'Женские': 'womens',
  'Унисекс': 'unisex'
};
```

### Constant: `CATEGORY_NAMES`
```typescript
const CATEGORY_NAMES: Record<string, string> = {
  'mens': 'Мужские часы',
  'womens': 'Женские часы',
  'unisex': 'Унисекс'
};
```

## Integration Notes

- This module is pure logic (no DB, no I/O)
- Consumed by `+page.server.ts` in preview and import actions
- `brandNames` map is used by cascade import to set proper brand names (not slug-to-titlecase)
- `categoryNames` map is used by cascade import to set proper category names

---

*Created: 2026-02-19*
