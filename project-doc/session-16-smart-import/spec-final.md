# Спецификация: Smart Import — автоопределение формата CSV поставщика

**Версия:** final
**Сессия:** Session-16
**Зависит от:** Session-3 (базовый import/export), Session-15 (ZIP/images инфраструктура — уже частично реализована)

---

## Контекст

Сейчас импорт работает только с "нашим" форматом CSV (заголовки: `slug`, `brand_slug`, `category_slug`, `name`, `sku`, `price`, `specs_json`, ...). Менеджер получает данные от поставщика в совершенно другом формате:

```
id товара,Имя,Бренд,Артикул (Ref),Цена,Фото,Коллекция,Пол,Размер (мм),Толщ. (мм),Мех-м,Калибр,Запас хода,Водозащита,Корпус,Ремешок/Браслет,Циферблат
```

Менеджер НЕ должен вручную конвертировать CSV — система должна сама определить формат и сконвертировать данные.

**Также:** кнопки Export недостаточно заметны на странице импорта; нужно улучшить UX.

---

## Есть сейчас vs Должно быть

| Аспект | Есть сейчас | Должно быть |
|--------|-------------|-------------|
| **Формат CSV** | Только "наш" формат с англ. заголовками | Автоопределение: "наш" или "поставщик" |
| **Бренд в CSV** | `brand_slug` (slug) | Также принимать `Бренд` (название) → auto-resolve |
| **Категория** | `category_slug` | Автомаппинг из `Пол`: Мужские→mens, Женские→womens, Унисекс→unisex |
| **Характеристики** | `specs_json` (JSON строка) | Также собирать из отдельных колонок (Размер, Механизм, Корпус...) |
| **Фото** | URL или имя файла | Также число (ID) → искать файл `{id}.jpg/png/webp` в ZIP |
| **Коллекция** | Нет поля | `Коллекция` → сохранять в description или отдельный маппинг |
| **Export кнопки** | Мелкие ссылки внизу инструкции | Крупные заметные кнопки вверху страницы |

---

## Формат CSV поставщика (эталонный пример)

Файл: `К загрузке - Лист1.csv` (170 товаров, 95% Tissot)

```csv
id товара,Имя,Бренд,Артикул (Ref),Цена,Фото,Коллекция,Пол,Размер (мм),Толщ, (мм),Мех-м,Калибр,Запас хода,Водозащита,Корпус,Ремешок/Браслет,Циферблат
17156,"Часы Tissot T125.610.17.081.00, Tissot Supersport, T-Sport",Tissot ,T125.610.17.081.00,55336,17156,Supersport Gent,Мужские,44,10,Кварц,ETA F06.115,-,100м,Сталь,Ткань,Серый
```

**Особенности данных:**
- `Цена` — уже в рублях (целое число без копеек)
- `Фото` — числовой ID (совпадает с `id товара`). Реальные изображения будут подгружаться позже или через ZIP
- `Бренд` — название с пробелом на конце (`"Tissot "` → нужен trim)
- `Имя` — может содержать запятые (в кавычках), включает артикул в названии
- `Размер (мм)` — иногда `20x20` (прямоугольные), иногда `45,5` (с запятой)
- `Толщ, (мм)` — заголовок содержит запятую! Может быть `10,5` или `10`
- `Запас хода` — `-` значит нет, иначе число или `"48 часов"`
- `Мех-м` — сокращения: `Кварц`, `Авто`, `Механ`, `Механ.рук`, `Механ.авто`, `Механика`
- `Коллекция` — название линейки (PRX, Seastar, T-Gold...)
- `Пол` — `Мужские`, `Женские`, `Унисекс`
- Все бренды: Tissot (~168 шт), ATOWAK (2-3 шт)

---

## Блок 1: Автоопределение формата CSV (csv-format-detector.ts)

**Новый файл:** `src/lib/server/import/csv-format-detector.ts`

### 1.1 Определение формата по заголовкам

```typescript
type CsvFormat = 'native' | 'supplier' | 'unknown';

function detectCsvFormat(headers: string[]): CsvFormat
```

**Логика:**
- Если есть `slug` или `brand_slug` или `specs_json` → `'native'` (наш формат)
- Если есть `Имя` или `Бренд` или `Артикул (Ref)` или `Пол` → `'supplier'`
- Иначе → `'unknown'`

### 1.2 Конвертация из формата поставщика

```typescript
function convertSupplierRows(rows: Record<string, string>[]): Record<string, string>[]
```

**Маппинг колонок:**

| Колонка поставщика | → Наше поле | Логика конвертации |
|---|---|---|
| `Имя` | `name` | trim, как есть |
| `Бренд` | `brand_slug` | trim → toLowerCase → заменить пробелы на `-` → транслитерация. Пример: `"Tissot "` → `"tissot"`, `"ATOWAK"` → `"atowak"` |
| `Артикул (Ref)` | `sku` | trim, как есть |
| `Цена` | `price` | Уже в рублях, как есть |
| `Пол` | `category_slug` | `Мужские` → `mens`, `Женские` → `womens`, `Унисекс` → `unisex` |
| `Коллекция` | *(в description)* | Добавить в начало description: `"Коллекция: {value}"` |
| `Фото` | `main_image` | Если число → `"{id}.jpg"` (как имя файла для поиска в ZIP). Если URL → как есть. Если пусто → пусто |
| `id товара` | *(игнорировать)* | Внешний ID, не используется |
| Спеки (8 колонок) | `specs_json` | Собрать в JSON (см. ниже) |

### 1.3 Сборка specs_json из отдельных колонок

Группировка:
```json
{
  "Корпус": [
    {"label": "Материал", "value": "Сталь"},
    {"label": "Диаметр", "value": "44 мм"},
    {"label": "Толщина", "value": "10 мм"},
    {"label": "Водозащита", "value": "100м"}
  ],
  "Механизм": [
    {"label": "Тип", "value": "Кварц"},
    {"label": "Калибр", "value": "ETA F06.115"},
    {"label": "Запас хода", "value": "—"}
  ],
  "Внешний вид": [
    {"label": "Циферблат", "value": "Серый"},
    {"label": "Ремешок/Браслет", "value": "Ткань"}
  ]
}
```

**Правила:**
- Пропускать спеки со значением `-` (прочерк) или пустые
- `Размер (мм)` → label `"Диаметр"`, value с суффиксом `" мм"` (если нет уже)
- `Толщ, (мм)` или `Толщ. (мм)` → label `"Толщина"`, value с суффиксом `" мм"`
- `Мех-м` → label `"Тип"`
- `Запас хода` → если `"-"` → пропустить, иначе добавить
- Запятые в числах (`10,5`) оставить как есть (это нормальный русский формат)

### 1.4 Автосоздание брендов и категорий

При формате `'supplier'` автоматически включать каскадный импорт:
- Бренды: если `brand_slug` не найден → создать с `name` из оригинальной колонки `Бренд`
- Категории: если `category_slug` (mens/womens/unisex) не найден → создать с русским именем (`Мужские часы`, `Женские часы`, `Унисекс`)

---

## Блок 2: Гибкая обработка имён файлов изображений

### 2.1 Расширенный поиск файлов в ZIP

**Обновить:** `src/lib/server/import/zip-handler.ts`

При resolveImageReferences, если точное имя не найдено в imageMap, пробовать варианты:

```
Исходное значение: "17156"
Пробуем найти в ZIP:
  17156.jpg, 17156.jpeg, 17156.png, 17156.webp, 17156.gif, 17156.avif
  images/17156.jpg, images/17156.png, ...
```

Если значение — число, искать файл с любым из поддерживаемых расширений.

### 2.2 Поддержка разных форматов входных файлов

**Обновить:** `zip-handler.ts` → `/\.(jpg|jpeg|png|webp|gif|avif|tiff|bmp|svg)$/i`

Добавить TIFF, BMP, SVG в список распознаваемых. Sharp поддерживает их все.

### 2.3 Имена файлов со спецсимволами

Обработка имён файлов:
- Дефисы: `watch-17156.jpg` → ОК
- Нижнее подчёркивание: `watch_17156.jpg` → ОК
- Пробелы: `my watch.jpg` → ОК (trim)
- Китайские иероглифы: `手表_17156.jpg` → ОК (не трогать unicode, только trim)
- Кириллица: `часы_тиссот.jpg` → ОК

**Важно:** при маппинге имён в imageMap использовать нормализованное имя:
- trim
- НЕ менять регистр (case-sensitive первый проход, case-insensitive fallback)
- НЕ менять unicode символы

---

## Блок 3: Улучшение UX страницы импорта

### 3.1 Export — крупные заметные кнопки

Переместить блок Export ВЫШЕ, сразу после заголовка страницы. Сделать кнопки крупнее, с иконками, как полноценные action buttons (не мелкие текстовые ссылки).

**Расположение на странице:**
```
[Import Data] заголовок
[Инструкция — как пользоваться] — свернуть по умолчанию (details/summary)

[=== EXPORT ===] — крупные кнопки
  [⬇ Products]  [⬇ Brands]  [⬇ Categories]
  [⬇ Cities]    [⬇ Filters]  [⬇ City Articles]

[=== IMPORT ===]
  1. Select Data Type
  2. Upload CSV File
  3. Preview / Import
```

### 3.2 Инструкцию свернуть по умолчанию

Блок "Как пользоваться импортом" сделать `<details>` (по умолчанию свёрнут). Те кто уже знают — не будут скроллить мимо. Новые пользователи — развернут.

### 3.3 Показать формат при Preview

Когда пользователь загрузил CSV и нажал Preview, в результате показать:
- `Формат: Стандартный` или `Формат: Поставщик (автоконвертация)`
- При формате поставщика — показать что будет сконвертировано:
  - `Бренд "Tissot" → tissot (новый, будет создан)`
  - `Пол "Мужские" → категория mens`
  - `Собраны характеристики из 8 колонок → specs_json`

### 3.4 Template кнопки — для обоих форматов

Добавить кнопку "Download Supplier Template" рядом с "Download Products Template":
- Products Template — наш формат (как сейчас)
- Supplier Template — формат поставщика (те же колонки что в CSV поставщика, пустой для заполнения)

---

## Блок 4: Интеграция в pipeline

### 4.1 Обновить +page.server.ts

В action `preview`:
1. После parseCSV → вызвать `detectCsvFormat(headers)`
2. Если `'supplier'` → вызвать `convertSupplierRows(rows)` → получить сконвертированные rows
3. Вернуть `detectedFormat` в результате preview

В action `import`:
1. Аналогично: после parseCSV → detect → convert если нужно
2. При формате supplier автоматически включать каскадный импорт (auto-create brands/categories)
3. Конвертированные rows передать в штатный `importProducts()`

### 4.2 Маппинг колонки `Фото` → файлы в ZIP

Если формат `'supplier'` и загружен ZIP:
- Колонка `Фото` (числовой ID) → искать файл `{id}.jpg/png/webp` в ZIP
- Если найден → обработать через sharp → подставить URL в `main_image`
- Если не найден → оставить пустым (изображение можно добавить позже через админку)

---

## Технические детали

### Файлы для создания:
- `src/lib/server/import/csv-format-detector.ts` — определение формата + конвертация

### Файлы для изменения:
- `src/routes/(admin)/admin/import/+page.server.ts` — вызов detect/convert в preview и import
- `src/routes/(admin)/admin/import/+page.svelte` — UX: export кнопки, формат в preview, свёрнутая инструкция
- `src/lib/server/import/zip-handler.ts` — расширенный поиск файлов (fuzzy filename match)
- `src/lib/server/import/product-importer.ts` — (минимальные изменения, если нужны)

### НЕ менять:
- csv-parser.ts — работает корректно, не трогать
- brand-importer.ts, category-importer.ts — используются как есть через каскадный импорт

---

## Образец данных для тестирования

Файл `К загрузке - Лист1.csv` находится в корне проекта (`/home/claude-user/dev/watch-site/`).
Содержит 170 товаров, преимущественно Tissot.

**Тест 1:** Загрузить CSV поставщика → Preview → должен показать "Формат: Поставщик" и конвертированные данные
**Тест 2:** Import CSV → должны создаться бренды (Tissot, ATOWAK), категории (mens, womens, unisex), 170 товаров с specs_json
**Тест 3:** Export Products → скачанный CSV в "нашем" формате, содержит specs_json
**Тест 4:** Re-import экспортированного CSV → "Формат: Стандартный", Updated: 170

---

## Критерии успеха

- [ ] CSV поставщика (170 товаров) импортируется без ошибок
- [ ] Бренды auto-created: Tissot, ATOWAK
- [ ] Категории auto-created: mens, womens, unisex (из поля Пол)
- [ ] specs_json собран из 8 колонок (Корпус/Механизм/Внешний вид)
- [ ] Спеки без "-" (прочерк) пропущены
- [ ] Export → Re-import round-trip без потерь
- [ ] Preview показывает обнаруженный формат
- [ ] Export кнопки заметные и удобные
- [ ] ZIP с числовыми именами файлов (17156.jpg) резолвится корректно
- [ ] Имена файлов с дефисами, подчёркиваниями, unicode работают
- [ ] `npm run build` — без ошибок

---

*Создано: 2026-02-19*
