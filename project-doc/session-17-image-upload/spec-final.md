# Session-17: Image Upload при импорте — Спецификация

**Версия:** final
**Дата:** 2026-02-19

---

## Есть сейчас vs Должно быть

| Аспект | Есть | Должно быть |
|--------|------|-------------|
| Загрузка изображений | Только через единый ZIP (CSV + images внутри) | Отдельное поле для ZIP с изображениями |
| Формат загрузки | Один input для CSV/ZIP | Два input: CSV отдельно + ZIP с фото отдельно |
| Несколько фото на товар | `gallery_images` поддерживает `\|` разделитель, но не используется | В CSV поставщика и нашем формате можно указать несколько фото через `;` |
| Привязка фото поставщика | Колонка `Фото` = один числовой ID | Колонка `Фото` поддерживает несколько значений через `;` (первое = main, остальные = gallery) |
| Изображения без CSV | Невозможно | Можно загрузить только ZIP с фото для существующих товаров (по SKU/slug в имени файла) |

---

## Что на выходе

Страница `/admin/import` с двумя полями загрузки:

1. **CSV файл** — основное поле (как сейчас)
2. **ZIP с изображениями** (опционально) — отдельное поле рядом/под CSV

### Сценарий 1: CSV + ZIP одновременно
- Менеджер загружает CSV от поставщика + ZIP с фотографиями
- Система автоматически связывает фото с товарами по `Фото` колонке
- Фото конвертируются в WebP, сохраняются в `data/media/images/products/`
- В preview видно какие товары получили изображения

### Сценарий 2: Только CSV (без фото)
- Как сейчас — товары импортируются без изображений
- Можно позже добавить фото через Сценарий 3 или вручную в карточке товара

### Сценарий 3: Только ZIP с фото (обновление существующих товаров)
- Менеджер загружает только ZIP с фото
- Система привязывает фото к существующим товарам по имени файла:
  - `T035.617.11.051.00.jpg` → товар с SKU `T035.617.11.051.00`
  - `17503.jpg` → товар с main_image = `17503.jpg`
- Удобно для "дозагрузки" фото позже

### Несколько фото на товар

В колонке `Фото` (поставщик) или `main_image` (наш формат) через `;`:
```
17503;17504;17505
```
- Первое значение → `main_image`
- Остальные → `gallery_images`

В ZIP файлы могут быть:
```
images/
  17503.jpg      ← main для товара
  17503_2.jpg    ← gallery (суффикс _2, _3 ...)
  17503_3.jpg
  T035.617.11.051.00.jpg
  T035.617.11.051.00_2.jpg
```

---

## Что нужно сделать

### Блок 1: Разделение полей загрузки в UI
- Поле 1: CSV файл (`.csv`) — обязательное
- Поле 2: ZIP с изображениями (`.zip`) — опциональное
- При наличии ZIP показать кол-во найденных изображений в preview
- Обновить preview: иконка фото рядом с товарами у которых нашлось изображение

### Блок 2: Серверная обработка двух файлов
- `+page.server.ts`: принять два FormData поля (csv_file + images_zip)
- Если есть ZIP — извлечь изображения через существующий `extractZipImport`
- Связать imageMap с CSV строками через `resolveImageReferences`
- Вернуть статистику: сколько фото обработано, сколько привязано

### Блок 3: Множественные фото на товар
- В `csv-format-detector.ts`: если `Фото` содержит `;`, разделить:
  - Первый → `main_image`
  - Остальные → `gallery_images` (через `|`)
- В `resolveImageReferences`: обработать `gallery_images` (уже поддерживает `|`)
- Поиск по суффиксам `_2`, `_3` в ZIP для автоматического gallery

### Блок 4: Только ZIP (обновление фото)
- Новый режим: если загружен только ZIP (без CSV)
- Сопоставить имена файлов с товарами в БД по SKU или slug
- Обновить `main_image` и `gallery_images` в существующих товарах
- Показать preview: какие товары получат фото

---

## Факторы реализации

- **image-processor.ts** — уже работает (sharp → WebP + thumbnail)
- **storage.ts** — уже работает (сохранение в data/media/)
- **zip-handler.ts** — уже работает (извлечение + fuzzy matching)
- **Serving:** нужно проверить/добавить endpoint для `/media/images/` (возможно через Nginx на production)
- **Размер ZIP:** лимит 50MB уже установлен. Для 170 товаров с 2-3 фото это ~20-30 MB — ок
- **Формат фото в ZIP:** jpg, png, webp, gif, avif — все поддерживаются

---

## Критерии успеха

- [ ] На странице импорта два поля: CSV и ZIP (отдельно)
- [ ] Загрузка CSV + ZIP одновременно → фото привязаны к товарам
- [ ] Загрузка только CSV → работает как раньше
- [ ] Загрузка только ZIP → обновляет фото у существующих товаров по SKU
- [ ] `Фото: 17503;17504` → main_image=17503.jpg, gallery=17504.jpg
- [ ] Суффиксы `_2`, `_3` в ZIP автоматически идут в gallery
- [ ] Preview показывает кол-во найденных изображений
- [ ] Фото конвертируются в WebP и отображаются на сайте
- [ ] На продакшне фото доступны через nginx (проверить/настроить `/media/images/`)

---

*Session-17 | 2026-02-19*
